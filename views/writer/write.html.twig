{% set namespace = 'Plasticbrain\\FlashMessages\\' %}

{% extends "layout.html.twig" %}

{% block title %}
Home
{%  endblock %}

{% block css %}
<link rel="stylesheet" href="../public/css/writer/write.css">
{% endblock %}


{% block navbar %}
{% include 'writer-navbar.html.twig' %}
{% endblock %}

{% block content %}
<div class="container">

	<div class="row">
		<div class="col-md-12">
			{% if flash.hasMessages() %}
				{{ flash.display() }}
			{% endif %}
		</div>
	</div>

	<div class="write-letter-container">

		<h2 class="letter-form-header">Write a letter</h2>

		<div class="dropdown">

			<button id="contact-list" type="button" 
				class="contact-list-toggle btn btn-primary" 
				data-toggle="dropdown" aria-haspopup="true" 
				aria-expanded="false"
			>
				{% if letter != null %}
					{{ letter.getContactName | title }}
				{% else %}
					Select A Contact
				{% endif %}
				<span class="caret"></span>
			</button>

			<ul class="dropdown-menu" aria-labelledby="contact-list">
				{% if contacts | length > 0 %}
					{% for contact in contacts %}
							<li data-contact-id="{{ contact.id }}">{{ contact.name | title }}</li>
					{% endfor %}
				{% else %}
					<li>No Contacts</li>
				{% endif %}
			</ul>

		</div>

		<form id="letter-form" action="../letter/create.php" method="POST">

			<textarea id="letter" name="letter"></textarea>

			<input id="contact_id" type="hidden" name="contact_id" value="{{ letter.getContactId }}">

			<input id="letter_id" type="hidden" name="letter_id" value="{{ letter.id }}">

			<input id="action" type="hidden" name="action" value="">

			<button id="letter-save" type="button" onclick="submitLetter('save')" class="letter-btn btn btn-primary">Save Draft</button>

			{% if letter.id > 0 %}
			<button id="letter-delete" type="button" onclick="deleteLetter()" class="letter-btn btn btn-danger">Delete Draft</button>
			{% endif %}
			
			<button id="letter-send" type="button" onclick="submitLetter('submit')" class="letter-btn btn btn-success pull-right">Send Letter</button>

		</form>

	</div>

</div>
{% endblock %}

{% block javascript %}
<script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
<script>
tinymce.init({
	selector: "textarea",
	menubar: false, 
	height : "250", 
	plugins: "noneditable",
  	noneditable_noneditable_class: "mceNonEditable",
	setup : function(ed)
	{
	    ed.on('init', function() 
	    {
	        this.getDoc().body.style.fontSize = '15px';
	    });
	}
});
</script>
<script type="text/javascript">

document.body.onload = function() {
	var letterId = $("#letter_id").val();

	if (letterId !== "") {
		
		$.get("../app/Helpers/getLetter.php?letter_id="+letterId, function(data, status) {
			if (data !== "error") {
				editor = tinyMCE.get('letter');
				editor.setContent(data);
			} else {
				alert("Error: There was a problem retrieving the letter.");
			}
		});

	}
}

$(document).ready(function() {



	$("ul.dropdown-menu li").click(function() {

		var $self = $(this);
		var $letterAddress = $("#letter-address");
		var contactId = $self.data('contact-id');
		var contactName = $self.text();

		if (contactId > 0) {
			$.get("../app/Helpers/getPrisonAddress.php?contact_id="+contactId, function(data, status) {

				editor = tinyMCE.get('letter');

				editor.dom.remove(editor.dom.select('section'));

				letter = editor.getContent();

				editor.setContent(data + letter);

				if (letter === "") {
					editor.dom.add(editor.getBody(), 'p', {}, '<br>');
				}
				
				editor.dom.setStyle(tinyMCE.activeEditor.dom.select('section'), 'font-size', '16px');
				editor.dom.setStyle(tinyMCE.activeEditor.dom.select('section'), 'margin-bottom', '50px');
				
				editor.selection.select(editor.getBody(), true);
				editor.selection.collapse(false);
				editor.focus();

		    });
		}

		if (contactName !== "No Contacts") {
			$("#contact-list").text(contactName).append(" <span class='caret'></span>");

			$("#contact_id").val(contactId);
		}

	});

	function checkForContact()
	{
		contactId = $("#contact_id").val();

		if (contactId === "") {
			return false;
		}

		return true;
	}

	submitLetter = function(action)
	{
		var actionInput = $("#action");

		actionInput.val(action);

		if (checkForContact()) {
			$("#letter-form").submit();
			return;
		}

		alert("You must select a contact");
	}

	deleteLetter = function ()
	{
		if (confirm("Are you sure you want to delete this letter?")) {
			submitLetter('delete');
		}	
	}

});
</script>
{% endblock %}